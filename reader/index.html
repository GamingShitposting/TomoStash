<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
html, body, iframe { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; border: none; background-color: white; }
p { margin: 1em; }
.bar { background-color: darkgray; padding-left: 4px; padding-right: 4px; overflow: hidden; }
.bar > a { margin-right: 4px; color: black; float: right; max-width: 40%; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
.bar > label > * { margin: 4px; }
.bar > label > button { min-width: 3em; }
</style>
</head>
<body>
<noscript><p>This application requires JavaScript.</p></noscript>
<script>
(function(payload){
    var siteUrl = 'https://gamingshitposting.github.io/TomoStash/';
    var barHeight = '40px';
    var itemsHeight = '32px';

    var tokens = payload.split('#');
    var extra = tokens[1];
    payload = tokens[0];
    document.body.innerHTML = '';

    if (extra) {
        try {
            extra = JSON.parse(extra);
        } catch (e) {
            extra = { chapter: extra };
            console.error(e);
        }
    } else {
        extra = {};
    }

    if (payload[0] === '/') {
        if (!payload.endsWith('/')) {
            payload += '/';
        }
        fetch('..' + payload).then(function(res){
            res.text().then(function(html){
                var dom = (new DOMParser()).parseFromString(html, 'text/html');
                var json = dom.querySelector('script[type="application/json"][id="tome"]').innerHTML;
                load(json, extra);
            });
        });
    } else {
        load(payload, extra);
    }

    function load(json, extra) {
        var tome = JSON.parse(json);
        var sysStore = tome.config.store;
        var tomeStore = tome.store ? tome.config.stores[tome.store] : sysStore;

        var readers = {
            villain: sysStore + "/Villain-gh-pages/#/reader?src=",
            foliate: sysStore + "/foliate-js-main/reader.html?url=",
        };

        var barExtra = (tome.chapters && (!extra.chapter || extra.showChapters) ?
            '<label><select name="chapter" title="Chapter"></select></label>' +
        '' : '');

        document.body.innerHTML +=
            '<style>'+
                'iframe { height: calc(100% - ' + barHeight + '); }' +
                '.bar { height: ' + barHeight + '; }' +
                '.bar > label > * { height: ' + itemsHeight + '; }' +
                '.bar > a { line-height: ' + barHeight + '; }' +
            '</style>' +
            '<div class="bar">' +
                barExtra +
                '<label><button name="reload" title="Reload">üîÑ</button></label>' +
                '<label><button name="fullscreen" title="Fullscreen">‚ÜîÔ∏è</button></label>' +
                '<a href="' + siteUrl + '" target="_blank" ' + (!checkExternalSite() ? 'hidden' : '') + '>Powered by TomoStash</a>' +
            '</div>';

        document.body.innerHTML += '<iframe allow="fullscreen" allowfullscreen="allowfullscreen"></iframe>';

        var reloadButton = document.body.querySelector('button[name="reload"]');

        if (tome.file) {
            reloadButton.addEventListener('click', function(){ displayVolume(tome.file); });
            displayVolume(tome.file);
        } else if (tome.chapters) {
            if (extra.chapter && !extra.showChapters) {
                reloadButton.addEventListener('click', function(){ displayVolume(extra.chapter); });
                displayVolume(extra.chapter);
            } else {
                var select = document.body.querySelector('select[name="chapter"]');
                function displayChapter(){
                    displayVolume(select.value);
                }
                tome.chapters.forEach(function(chapter){
                    select.appendChild(Object.assign(document.createElement('option'), { textContent: chapter, selected: chapter === extra.chapter }));
                });
                select.addEventListener('change', displayChapter);
                reloadButton.addEventListener('click', displayChapter);
                displayVolume(select.value);
            }
        } else {
            return document.body.innerHTML += '<p>No online reading available for this tome, please check downloads.</p>';
        }

        document.body.querySelector('button[name="fullscreen"]').addEventListener('click', function(){ document.body.requestFullscreen(); });

        function displayVolume(file) {
            var ext = file.split('.').slice(-1)[0];
            var runtime = {
                cbz: readers.villain,
            }[ext] || readers.foliate;
            document.querySelector('iframe').src = '';
            setTimeout(function(){
                document.querySelector('iframe').src = runtime + tomeStore + '/tomes/' + (tome.folder ? tome.slug.split('/')[0] : tome.slug) + '/' + tome.folder + '/' + file;
            }, 10);
        }
    }

    function checkExternalSite() {
        try {
            return (location.hostname === 'localhost'
                ? false
                : !window.top.location.href.startsWith(siteUrl));
        } catch (e) {
            console.error(e);
            return true;
        }
    }
})(decodeURIComponent(location.hash.slice(1)).trim());
</script>
</body>
</html>